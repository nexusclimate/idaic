[build]
  base = "portal"
  command = "cd .. && npm install --omit=dev --legacy-peer-deps && cd portal && npm install --legacy-peer-deps && VITE_SUPABASE_URL=$SUPABASE_URL VITE_SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY npm run build && mv dist/index.html dist/app.html && mkdir -p ../public && cp -r dist/* ../public/"
  publish = "../public"
  functions = "../netlify/functions"

[build.environment]
  NODE_VERSION = "20"
  NPM_VERSION = "9.8.1"
  NPM_FLAGS = "--legacy-peer-deps"
  NETLIFY_SKIP_INSTALL = "true"
  NETLIFY_INSTALL_COMMAND = "echo \"Skipping Netlify install\""

[dev]
  functions = "../netlify/functions"

# Global headers to allow iframe embedding
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "ALLOWALL"
    Content-Security-Policy = "frame-ancestors 'self' https://members.nexusclimate.co https://climatesolutions.news https://news.nexusclimate.vc https://uaenews.nexusclimate.vc"

[[redirects]]
  from = "/"
  to = "/login.html"
  status = 200

[[redirects]]
  from = "/app"
  to = "/app.html"
  status = 200

[[redirects]]
  from = "/app/*"
  to = "/app.html"
  status = 200

[[redirects]]
  from = "/newuser-form"
  to = "/newmember-form.html"
  status = 200

[[redirects]]
  from = "/newmember-signup"
  to = "/newmember-form.html"
  status = 200

[[redirects]]
  from = "/newmember-form"
  to = "/newmember-form.html"
  status = 200

# Event pages - redirect to event-page.html with UUID parameter
[[redirects]]
  from = "/events-*"
  to = "/event-page.html"
  status = 200

# Poll pages - redirect to poll-page.html with UUID parameter
[[redirects]]
  from = "/poll-*"
  to = "/poll-page.html"
  status = 200