[build]
  base = "."
  command = "npm install --legacy-peer-deps && cd portal && node -e \"try { require('fs').unlinkSync('package-lock.json'); } catch(e) {}\" && npm install --legacy-peer-deps && VITE_SUPABASE_URL=$SUPABASE_URL VITE_SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY npm run build && mv dist/index.html dist/app.html && cp -r dist/* public/"
  publish = "public"
  functions = "netlify/functions"

[dev]
  functions = "../netlify/functions"

# Global headers to allow iframe embedding
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "ALLOWALL"
    Content-Security-Policy = "frame-ancestors 'self' https://members.nexusclimate.co https://climatesolutions.news https://news.nexusclimate.vc https://uaenews.nexusclimate.vc"

[[redirects]]
  from = "/"
  to = "/login.html"
  status = 200

[[redirects]]
  from = "/app"
  to = "/app.html"
  status = 200

[[redirects]]
  from = "/app/*"
  to = "/app.html"
  status = 200

[[redirects]]
  from = "/newuser-form"
  to = "/newmember-form.html"
  status = 200

[[redirects]]
  from = "/newmember-signup"
  to = "/newmember-form.html"
  status = 200

[[redirects]]
  from = "/newmember-form"
  to = "/newmember-form.html"
  status = 200

# Event pages - redirect to event-page.html with UUID parameter
[[redirects]]
  from = "/events-*"
  to = "/event-page.html"
  status = 200

# Poll pages - redirect to poll-page.html with UUID parameter
[[redirects]]
  from = "/poll-*"
  to = "/poll-page.html"
  status = 200