<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Poll - IDAIC</title>
  <link rel="stylesheet" href="/tailwind.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body { 
      font-family: 'Inter', sans-serif;
      overflow-x: hidden; /* Prevent horizontal scrolling */
    }
    .poll-header {
      background-image: url('https://xnjpbkcqfuvegiwdxypw.supabase.co/storage/v1/object/public/logos/download_events.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      min-height: 300px; /* Minimum height for mobile */
      width: 100%;
      max-width: 100vw; /* Prevent overflow */
    }
    @media (min-width: 640px) {
      .poll-header {
        min-height: 400px;
      }
    }
    @media (min-width: 1024px) {
      .poll-header {
        min-height: 500px;
      }
    }
    .poll-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
    }
    .poll-header-content {
      position: relative;
      z-index: 1;
    }
    /* Ensure images are responsive */
    img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="min-h-screen">
    <!-- Loading State -->
    <div id="loading" class="flex items-center justify-center min-h-screen">
      <div class="text-gray-500">Loading poll...</div>
    </div>

    <!-- Poll Page -->
    <div id="poll-content" class="hidden">
      <!-- Header Banner -->
      <div class="poll-header text-white">
        <div class="poll-header-content max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 pt-48 sm:pt-56 lg:pt-64 pb-0 flex items-end justify-center min-h-full">
          <div class="w-full text-center mb-64 sm:mb-72 lg:mb-80">
            <div class="flex flex-col items-center">
              <div class="w-full max-w-lg mx-auto">
                <h1 id="poll-title" class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-2 break-words" style="color: #f97316; word-wrap: break-word; overflow-wrap: break-word;">Event Time Poll</h1>
                <div id="poll-subtitle" class="text-gray-100 text-xs sm:text-sm lg:text-base break-words" style="word-wrap: break-word; overflow-wrap: break-word;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <!-- Success Message -->
        <div id="success-message" class="hidden mb-4 sm:mb-6 p-3 sm:p-4 bg-green-50 border border-green-200 rounded-md">
          <div class="flex items-start sm:items-center">
            <svg class="h-5 w-5 text-green-500 mr-2 flex-shrink-0 mt-0.5 sm:mt-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-xs sm:text-sm text-green-800 break-words">Your vote has been recorded!</p>
          </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden mb-4 sm:mb-6 p-3 sm:p-4 bg-red-50 border border-red-200 rounded-md">
          <p class="text-xs sm:text-sm text-red-800 break-words" id="error-text"></p>
        </div>

        <!-- Deadline Notice -->
        <div id="deadline-notice" class="mb-4 sm:mb-6"></div>

        <!-- Event Details -->
        <div id="event-details-container" class="bg-white rounded-lg shadow-lg p-4 sm:p-6 lg:p-8 mb-6"></div>

        <!-- Poll Details -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 lg:p-8 mb-6">
          <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-900">Vote for Your Preferred Time</h2>
          <p class="text-sm sm:text-base text-gray-700 mb-4 sm:mb-6">Please select your preferred time slot for this event:</p>
          
          <div id="time-slots" class="space-y-3 sm:space-y-4 mb-4 sm:mb-6"></div>
        </div>

        <!-- Voting Form -->
        <div id="voting-form-container" class="bg-white rounded-lg shadow-lg p-4 sm:p-6 lg:p-8">
          <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-900">Cast Your Vote</h2>
          
          <form id="voting-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Name *
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Email *
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Company
              </label>
              <input
                type="text"
                id="company"
                name="company"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Preferred Time Slot *
              </label>
              <div id="time-slot-options" class="space-y-2"></div>
            </div>

            <button
              type="submit"
              id="submit-btn"
              class="w-full px-4 sm:px-6 py-2.5 sm:py-3 bg-orange-500 text-white rounded-md text-sm sm:text-base font-medium hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Submit Vote
            </button>
          </form>
        </div>
      </div>

      <!-- Footer -->
      <footer class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 mt-6 sm:mt-8 border-t border-gray-200">
        <div class="flex flex-col items-center justify-center mb-4 sm:mb-6">
          <a href="https://www.idaic.org" target="_blank" rel="noopener noreferrer" class="mb-3 sm:mb-4">
            <img id="idaic-logo" alt="IDAIC Logo" class="h-10 sm:h-12 w-auto object-contain max-w-full" style="display: none;" />
          </a>
        </div>
        <p class="text-xs sm:text-sm text-gray-600 text-center leading-relaxed px-2">
          This event is created and managed by IDAIC, under the direction of the meeting organizer. The data processing that occurs for purposes of this event is subject to the terms of the meeting organiser.
        </p>
      </footer>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden items-center justify-center min-h-screen" style="display: none;">
      <div class="text-center">
        <p class="text-red-600 mb-4">Poll not found</p>
        <a href="https://www.idaic.org" class="text-orange-500 hover:underline">Return to IDAIC</a>
      </div>
    </div>
  </div>

  <script>
    // Get event ID from URL (poll page uses event UUID)
    let eventId = '';
    let pollData = null; // Store poll data globally
    
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const pollPath = pathParts[pathParts.length - 1];
    if (pollPath && pollPath.startsWith('poll-')) {
      eventId = pollPath.replace('poll-', '');
    } else if (pathParts.length >= 2 && pathParts[pathParts.length - 2] === 'poll') {
      eventId = pathParts[pathParts.length - 1];
    }
    
    // Fallback: try to get from query parameter
    if (!eventId) {
      const urlParams = new URLSearchParams(window.location.search);
      eventId = urlParams.get('id') || urlParams.get('event_id');
    }
    
    console.log('Event ID extracted from URL:', eventId);

    // Fetch IDAIC logo
    async function loadIdaicLogo() {
      try {
        const response = await fetch('/.netlify/functions/orgs');
        if (response.ok) {
          const orgs = await response.json();
          const idaic = orgs.find(org => 
            org.name && (
              org.name.toLowerCase().includes('idaic') ||
              org.name.toLowerCase() === 'idaic'
            ) && org.logo_url
          );
          if (idaic && idaic.logo_url) {
            const logoImg = document.getElementById('idaic-logo');
            logoImg.src = idaic.logo_url;
            logoImg.style.display = 'block';
          }
        }
      } catch (err) {
        console.error('Error fetching IDAIC logo:', err);
      }
    }

    // Fetch and pre-fill user details from active session
    async function prefillUserDetails() {
      try {
        // Check for password login first
        const isPasswordLogin = localStorage.getItem('idaic-password-login');
        const passwordEmail = localStorage.getItem('idaic-password-email');
        const token = localStorage.getItem('idaic-token');
        
        let userEmail = null;
        
        if (isPasswordLogin === 'true' && passwordEmail && token) {
          // Password login - use email from localStorage
          userEmail = passwordEmail;
        } else if (token) {
          // Try to get email from Supabase session using the token
          // First, try to decode the token to get user info (if it's a JWT)
          try {
            // Call Supabase auth API to get user info
            const supabaseUrl = 'https://xnjpbkcqfuvegiwdxypw.supabase.co';
            const authResponse = await fetch(`${supabaseUrl}/auth/v1/user`, {
              headers: {
                'Authorization': `Bearer ${token}`,
                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhuanBia2NxZnV2ZWdpd2R4eXB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTI3NDE3NDAsImV4cCI6MjAyODMxNzc0MH0.7qJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq'
              }
            });
            
            if (authResponse.ok) {
              const userData = await authResponse.json();
              if (userData && userData.email) {
                userEmail = userData.email;
              }
            }
          } catch (err) {
            console.log('Could not get user from token:', err);
          }
        }
        
        if (!userEmail) {
          // No active session found
          return;
        }
        
        // Fetch user profile using email
        const profileUrl = `/.netlify/functions/userProfile?email=${encodeURIComponent(userEmail)}`;
        
        const profileResponse = await fetch(profileUrl, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        
        if (profileResponse.ok) {
          const userProfile = await profileResponse.json();
          
          if (userProfile) {
            // Pre-fill form fields
            const nameField = document.getElementById('name');
            const emailField = document.getElementById('email');
            const companyField = document.getElementById('company');
            
            if (nameField && userProfile.name) {
              nameField.value = userProfile.name;
            }
            if (emailField && userProfile.email) {
              emailField.value = userProfile.email;
            }
            if (companyField && userProfile.company) {
              companyField.value = userProfile.company;
            }
          }
        }
      } catch (err) {
        console.log('Could not pre-fill user details:', err);
        // Silently fail - user can still fill form manually
      }
    }

    // Load poll data
    async function loadPoll() {
      try {
        if (!eventId) {
          console.error('No event ID found in URL');
          document.getElementById('loading').classList.add('hidden');
          const errorState = document.getElementById('error-state');
          errorState.classList.remove('hidden');
          errorState.style.display = 'flex';
          errorState.querySelector('p').textContent = 'Invalid poll URL. Please check the link and try again.';
          return;
        }

        console.log('Fetching poll for event_id:', eventId);
        const response = await fetch(`/.netlify/functions/polls?event_id=${eventId}`);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          console.error('Failed to fetch poll:', response.status, errorData);
          document.getElementById('loading').classList.add('hidden');
          const errorState = document.getElementById('error-state');
          errorState.classList.remove('hidden');
          errorState.style.display = 'flex';
          errorState.querySelector('p').textContent = errorData.error || 'Poll not found. Please check the link and try again.';
          return;
        }
        
        const poll = await response.json();
        console.log('Poll data received:', poll);
        
        if (!poll || !poll.id) {
          console.error('Poll data is invalid:', poll);
          document.getElementById('loading').classList.add('hidden');
          const errorState = document.getElementById('error-state');
          errorState.classList.remove('hidden');
          errorState.style.display = 'flex';
          const errorText = errorState.querySelector('p');
          if (errorText) {
            errorText.textContent = 'Poll not found. Please check the link and try again.';
          }
          return;
        }
        
        // Store poll data globally for form submission
        pollData = poll;

        // Helper function to format date with GST timezone
        function formatDateWithGST(date) {
          const options = {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Asia/Dubai'
          };
          const formatted = date.toLocaleDateString('en-GB', options);
          // Replace timezone abbreviation with GST
          return formatted.replace(/\sGMT\+4|\sGST/, '') + ' GST';
        }
        
        function formatEventDateWithGST(date) {
          const options = {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            timeZone: 'Asia/Dubai'
          };
          const formatted = date.toLocaleDateString('en-GB', options);
          return formatted.replace(/\sGMT\+4|\sGST/, '') + ' GST';
        }

        // Get event details from poll response
        const event = poll.event || {};
        const eventTitle = event.title || 'Event';
        const eventDescription = event.description || '';
        const eventLocation = event.location || '';
        
        const eventDateObj = event.event_date ? new Date(event.event_date) : null;
        const eventDate = eventDateObj ? formatEventDateWithGST(eventDateObj) : '';

        document.getElementById('poll-title').textContent = `Time Poll: ${eventTitle}`;
        document.getElementById('poll-subtitle').textContent = 'Select your preferred time slot';
        
        // Display event details
        const eventDetailsContainer = document.getElementById('event-details-container');
        if (eventDetailsContainer) {
          // Only show event details if there's meaningful content
          if (eventDescription || eventDate || eventLocation) {
            eventDetailsContainer.innerHTML = `
              <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-900">${eventTitle}</h2>
              ${eventDescription ? `<div class="prose max-w-none text-sm sm:text-base text-gray-700 mb-3 sm:mb-4 break-words">${eventDescription.replace(/\n/g, '<br>')}</div>` : ''}
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                ${eventDate ? `<div><strong class="text-xs sm:text-sm text-gray-900">Event Date:</strong> <div class="text-sm sm:text-base text-gray-900">${eventDate}</div></div>` : ''}
                ${eventLocation ? `<div><strong class="text-xs sm:text-sm text-gray-900">Location:</strong> <span class="text-sm sm:text-base text-gray-900 break-words">${eventLocation}</span></div>` : ''}
              </div>
            `;
          } else {
            // Hide container if no event details to show
            eventDetailsContainer.style.display = 'none';
          }
        }

        // Check if poll deadline has passed
        const deadline = poll.deadline ? new Date(poll.deadline) : null;
        const now = new Date();
        const isDeadlinePassed = deadline && now > deadline;
        
        // Display deadline notice
        const deadlineNotice = document.getElementById('deadline-notice');
        if (deadline) {
          const deadlineStr = formatDateWithGST(deadline);
          
          if (isDeadlinePassed) {
            deadlineNotice.innerHTML = `
              <div class="p-3 sm:p-4 bg-red-50 border border-red-200 rounded-md mb-4 sm:mb-6">
                <p class="text-xs sm:text-sm text-red-800 break-words">
                  <strong>Voting Closed:</strong> The poll deadline has passed
                </p>
                <div class="text-xs sm:text-sm text-red-700 mt-1 break-words" style="color: #f97316; font-weight: bold;">${deadlineStr}</div>
              </div>
            `;
            // Disable voting form
            document.getElementById('voting-form-container').classList.add('hidden');
          } else {
            deadlineNotice.innerHTML = `
              <div class="p-3 sm:p-4 bg-blue-50 border border-blue-200 rounded-md mb-4 sm:mb-6">
                <p class="text-xs sm:text-sm text-blue-800 break-words">
                  <strong>Voting Deadline:</strong>
                </p>
                <div class="text-xs sm:text-sm text-blue-700 mt-1 break-words" style="color: #f97316; font-weight: bold;">${deadlineStr}</div>
              </div>
            `;
          }
        }

        // Display time slots with vote counts
        const timeSlotsContainer = document.getElementById('time-slots');
        const voteOptionsContainer = document.getElementById('time-slot-options');
        
        poll.time_slots.forEach((slot, index) => {
          const date = new Date(slot);
          const formattedDate = formatDateWithGST(date);
          
          const voteCount = poll.voteCounts?.[index] || 0;
          
          // Display slot with vote count
          const slotDiv = document.createElement('div');
          slotDiv.className = 'p-3 sm:p-4 border border-gray-200 rounded-lg';
          slotDiv.innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0">
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-sm sm:text-base text-gray-900">Option ${index + 1}</div>
                <div class="text-sm sm:text-base break-words" style="color: #f97316; font-weight: bold;">${formattedDate}</div>
              </div>
              <div class="text-xs sm:text-sm text-gray-600 whitespace-nowrap">
                ${voteCount} ${voteCount === 1 ? 'vote' : 'votes'}
              </div>
            </div>
          `;
          timeSlotsContainer.appendChild(slotDiv);

          // Radio button option
          const radioDiv = document.createElement('div');
          radioDiv.className = 'flex items-center p-3 sm:p-4 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer';
          radioDiv.innerHTML = `
            <input
              type="radio"
              id="slot-${index}"
              name="time_slot"
              value="${index}"
              required
              class="mr-2 sm:mr-3 flex-shrink-0"
            />
            <label for="slot-${index}" class="flex-1 cursor-pointer min-w-0">
              <div class="text-sm sm:text-base break-words" style="color: #f97316; font-weight: bold;">${formattedDate}</div>
              <div class="text-xs text-gray-500 mt-1">${voteCount} ${voteCount === 1 ? 'vote' : 'votes'}</div>
            </label>
          `;
          voteOptionsContainer.appendChild(radioDiv);
        });

        // Check if already voted
        const urlParams = new URLSearchParams(window.location.search);
        const voted = urlParams.get('voted') === 'true';
        if (voted) {
          document.getElementById('success-message').classList.remove('hidden');
          document.getElementById('voting-form-container').classList.add('hidden');
          
          // Auto-close after 5 seconds if already voted
          const successText = document.getElementById('success-message').querySelector('p');
          let countdown = 5;
          successText.textContent = `Your vote has been recorded! This page will close in ${countdown} seconds...`;
          
          const countdownInterval = setInterval(() => {
            countdown--;
            if (countdown > 0) {
              successText.textContent = `Your vote has been recorded! This page will close in ${countdown} second${countdown !== 1 ? 's' : ''}...`;
            } else {
              clearInterval(countdownInterval);
              try {
                if (window.opener) {
                  window.close();
                } else {
                  window.location.href = 'https://www.idaic.org';
                }
              } catch (e) {
                window.location.href = 'https://www.idaic.org';
              }
            }
          }, 1000);
        }

        // Pre-fill user details from active session
        await prefillUserDetails();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('poll-content').classList.remove('hidden');
      } catch (err) {
        console.error('Error loading poll:', err);
        document.getElementById('loading').classList.add('hidden');
        const errorState = document.getElementById('error-state');
        errorState.classList.remove('hidden');
        errorState.style.display = 'flex';
      }
    }

    // Handle form submission
    document.getElementById('voting-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const successMessage = document.getElementById('success-message');
      const errorMessage = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      
      // Hide previous messages
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      if (!pollData || !pollData.id) {
        errorText.textContent = 'Poll data not loaded. Please refresh the page.';
        errorMessage.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Cast Your Vote';
        return;
      }
      
      const selectedSlot = document.querySelector('input[name="time_slot"]:checked');
      if (!selectedSlot) {
        errorText.textContent = 'Please select a time slot.';
        errorMessage.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Cast Your Vote';
        return;
      }
      
      const formData = {
        poll_id: pollData.id,
        selected_slot_index: parseInt(selectedSlot.value),
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        company: document.getElementById('company').value.trim()
      };

      try {
        const response = await fetch('/.netlify/functions/pollVotes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to submit vote');
        }

        // Show success message
        successMessage.classList.remove('hidden');
        document.getElementById('voting-form-container').classList.add('hidden');
        
        // Update URL to show voted state
        window.history.replaceState({}, '', `${window.location.pathname}?voted=true`);
        
        // Update success message to show countdown
        const successText = successMessage.querySelector('p');
        let countdown = 5;
        successText.textContent = `Your vote has been recorded! This page will close in ${countdown} seconds...`;
        
        const countdownInterval = setInterval(() => {
          countdown--;
          if (countdown > 0) {
            successText.textContent = `Your vote has been recorded! This page will close in ${countdown} second${countdown !== 1 ? 's' : ''}...`;
          } else {
            clearInterval(countdownInterval);
            // Try to close the window/tab
            // If window was opened by script, it can be closed
            // Otherwise, redirect to IDAIC homepage
            try {
              if (window.opener) {
                // Window was opened by another window - can close it
                window.close();
              } else {
                // Regular tab - redirect to IDAIC homepage
                window.location.href = 'https://www.idaic.org';
              }
            } catch (e) {
              // If closing fails (some browsers block this), redirect instead
              window.location.href = 'https://www.idaic.org';
            }
          }
        }, 1000);
      } catch (err) {
        errorText.textContent = err.message;
        errorMessage.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Vote';
      }
    });

    // Auto-fill form fields from URL parameters, localStorage, or parent window (for members portal)
    async function autoFillForm() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // Get data from URL parameters
      const name = urlParams.get('name');
      const email = urlParams.get('email');
      const company = urlParams.get('company');
      
      // Try to get user data from localStorage (for logged-in users)
      try {
        const isPasswordLogin = localStorage.getItem('idaic-password-login');
        const passwordEmail = localStorage.getItem('idaic-password-email');
        const localToken = localStorage.getItem('idaic-token');
        
        // Try to fetch user profile if we have an email
        if (passwordEmail) {
          try {
            const response = await fetch(`/.netlify/functions/userProfile?email=${encodeURIComponent(passwordEmail)}`, {
              headers: localToken ? {
                'Authorization': `Bearer ${localToken}`
              } : {}
            });
            
            if (response.ok) {
              const userData = await response.json();
              if (userData) {
                if (userData.name && !document.getElementById('name').value) {
                  document.getElementById('name').value = userData.name;
                }
                if (userData.email && !document.getElementById('email').value) {
                  document.getElementById('email').value = userData.email;
                }
                if (userData.company && !document.getElementById('company').value) {
                  document.getElementById('company').value = userData.company;
                }
              }
            }
          } catch (err) {
            console.log('Could not fetch user profile:', err);
            // Fallback to email from localStorage if available
            if (passwordEmail && !document.getElementById('email').value) {
              document.getElementById('email').value = passwordEmail;
            }
          }
        }
      } catch (e) {
        console.log('Error accessing localStorage:', e);
      }
      
      // Try to get data from parent window if in iframe (members portal)
      let messageListener = null;
      try {
        if (window.parent && window.parent !== window) {
          // Request user data from parent (members portal)
          window.parent.postMessage({ type: 'requestUserData' }, '*');
          
          // Listen for response with timeout and cleanup
          messageListener = function(event) {
            // Only process messages from expected origin
            if (event.data && event.data.type === 'userData') {
              const data = event.data.data || {};
              if (data.name && !document.getElementById('name').value) {
                document.getElementById('name').value = data.name;
              }
              if (data.email && !document.getElementById('email').value) {
                document.getElementById('email').value = data.email;
              }
              if (data.company && !document.getElementById('company').value) {
                document.getElementById('company').value = data.company;
              }
              // Remove listener after receiving data
              if (messageListener) {
                window.removeEventListener('message', messageListener);
                messageListener = null;
              }
            }
          };
          
          window.addEventListener('message', messageListener);
          
          // Cleanup listener after 5 seconds to prevent memory leaks
          setTimeout(() => {
            if (messageListener) {
              window.removeEventListener('message', messageListener);
              messageListener = null;
            }
          }, 5000);
        }
      } catch (e) {
        // Cross-origin restrictions - ignore
        console.log('Cannot access parent window:', e);
        if (messageListener) {
          window.removeEventListener('message', messageListener);
        }
      }
      
      // Fill from URL parameters if available (lowest priority - won't overwrite existing values)
      if (name && !document.getElementById('name').value) {
        document.getElementById('name').value = decodeURIComponent(name);
      }
      if (email && !document.getElementById('email').value) {
        document.getElementById('email').value = decodeURIComponent(email);
      }
      if (company && !document.getElementById('company').value) {
        document.getElementById('company').value = decodeURIComponent(company);
      }
    }

    // Initialize
    loadIdaicLogo();
    loadPoll().then(() => {
      // Auto-fill after poll loads and form is visible
      setTimeout(() => {
        autoFillForm();
      }, 100);
    });
  </script>
</body>
</html>

