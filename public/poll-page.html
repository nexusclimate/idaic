<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Poll - IDAIC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body { 
      font-family: 'Inter', sans-serif;
    }
    .poll-header {
      background-image: url('https://xnjpbkcqfuvegiwdxypw.supabase.co/storage/v1/object/public/logos/download_events.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }
    .poll-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
    }
    .poll-header-content {
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="min-h-screen">
    <!-- Loading State -->
    <div id="loading" class="flex items-center justify-center min-h-screen">
      <div class="text-gray-500">Loading poll...</div>
    </div>

    <!-- Poll Page -->
    <div id="poll-content" class="hidden">
      <!-- Header Banner -->
      <div class="poll-header text-white">
        <div class="poll-header-content max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-24 sm:py-32 lg:py-40">
          <div class="flex items-center mb-6">
            <a href="https://www.idaic.org" target="_blank" rel="noopener noreferrer" class="mr-6">
              <img id="idaic-logo" alt="IDAIC Logo" class="h-12 w-auto object-contain" style="display: none;" />
            </a>
            <div class="flex-1">
              <h1 id="poll-title" class="text-3xl sm:text-4xl font-bold mb-2" style="color: #f97316;">Event Time Poll</h1>
              <div id="poll-subtitle" class="text-gray-100 text-sm sm:text-base"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Success Message -->
        <div id="success-message" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-md">
          <div class="flex items-center">
            <svg class="h-5 w-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-sm text-green-800">Your vote has been recorded!</p>
          </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
          <p class="text-sm text-red-800" id="error-text"></p>
        </div>

        <!-- Poll Details -->
        <div class="bg-white rounded-lg shadow-lg p-6 sm:p-8 mb-6">
          <h2 class="text-xl font-semibold mb-4 text-gray-900">Vote for Your Preferred Time</h2>
          <p class="text-gray-700 mb-6">Please select your preferred time slot for this event:</p>
          
          <div id="time-slots" class="space-y-4 mb-6"></div>
        </div>

        <!-- Voting Form -->
        <div id="voting-form-container" class="bg-white rounded-lg shadow-lg p-6 sm:p-8">
          <h2 class="text-xl font-semibold mb-4 text-gray-900">Cast Your Vote</h2>
          
          <form id="voting-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Name *
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Email *
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Company
              </label>
              <input
                type="text"
                id="company"
                name="company"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Preferred Time Slot *
              </label>
              <div id="time-slot-options" class="space-y-2"></div>
            </div>

            <button
              type="submit"
              id="submit-btn"
              class="w-full px-6 py-3 bg-orange-500 text-white rounded-md text-base font-medium hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Submit Vote
            </button>
          </form>
        </div>
      </div>

      <!-- Footer -->
      <footer class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mt-8 border-t border-gray-200">
        <p class="text-xs text-gray-600 text-center leading-relaxed">
          This event is created and managed by IDAIC, under the direction of the meeting organizer. The data processing that occurs for purposes of this event is subject to the terms of the meeting organiser.
        </p>
      </footer>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden items-center justify-center min-h-screen" style="display: none;">
      <div class="text-center">
        <p class="text-red-600 mb-4">Poll not found</p>
        <a href="https://www.idaic.org" class="text-orange-500 hover:underline">Return to IDAIC</a>
      </div>
    </div>
  </div>

  <script>
    // Get event ID from URL (poll page uses event UUID)
    let eventId = '';
    let pollData = null; // Store poll data globally
    
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const pollPath = pathParts[pathParts.length - 1];
    if (pollPath && pollPath.startsWith('poll-')) {
      eventId = pollPath.replace('poll-', '');
    } else if (pathParts.length >= 2 && pathParts[pathParts.length - 2] === 'poll') {
      eventId = pathParts[pathParts.length - 1];
    }
    
    // Fallback: try to get from query parameter
    if (!eventId) {
      const urlParams = new URLSearchParams(window.location.search);
      eventId = urlParams.get('id') || urlParams.get('event_id');
    }
    
    console.log('Event ID extracted from URL:', eventId);

    // Fetch IDAIC logo
    async function loadIdaicLogo() {
      try {
        const response = await fetch('/.netlify/functions/orgs');
        if (response.ok) {
          const orgs = await response.json();
          const idaic = orgs.find(org => 
            org.name && (
              org.name.toLowerCase().includes('idaic') ||
              org.name.toLowerCase() === 'idaic'
            ) && org.logo_url
          );
          if (idaic && idaic.logo_url) {
            const logoImg = document.getElementById('idaic-logo');
            logoImg.src = idaic.logo_url;
            logoImg.style.display = 'block';
          }
        }
      } catch (err) {
        console.error('Error fetching IDAIC logo:', err);
      }
    }

    // Load poll data
    async function loadPoll() {
      try {
        if (!eventId) {
          console.error('No event ID found in URL');
          document.getElementById('loading').classList.add('hidden');
          const errorState = document.getElementById('error-state');
          errorState.classList.remove('hidden');
          errorState.style.display = 'flex';
          errorState.querySelector('p').textContent = 'Invalid poll URL. Please check the link and try again.';
          return;
        }

        console.log('Fetching poll for event_id:', eventId);
        const response = await fetch(`/.netlify/functions/polls?event_id=${eventId}`);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          console.error('Failed to fetch poll:', response.status, errorData);
          document.getElementById('loading').classList.add('hidden');
          const errorState = document.getElementById('error-state');
          errorState.classList.remove('hidden');
          errorState.style.display = 'flex';
          errorState.querySelector('p').textContent = errorData.error || 'Poll not found. Please check the link and try again.';
          return;
        }
        
        const poll = await response.json();
        console.log('Poll data received:', poll);
        
        if (!poll || !poll.id) {
          console.error('Poll data is invalid:', poll);
          document.getElementById('loading').classList.add('hidden');
          const errorState = document.getElementById('error-state');
          errorState.classList.remove('hidden');
          errorState.style.display = 'flex';
          const errorText = errorState.querySelector('p');
          if (errorText) {
            errorText.textContent = 'Poll not found. Please check the link and try again.';
          }
          return;
        }
        
        // Store poll data globally for form submission
        pollData = poll;

        // Helper function to format date with GST timezone
        function formatDateWithGST(date) {
          const options = {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Asia/Dubai'
          };
          const formatted = date.toLocaleDateString('en-GB', options);
          // Replace timezone abbreviation with GST
          return formatted.replace(/\sGMT\+4|\sGST/, '') + ' GST';
        }
        
        function formatEventDateWithGST(date) {
          const options = {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            timeZone: 'Asia/Dubai'
          };
          const formatted = date.toLocaleDateString('en-GB', options);
          return formatted.replace(/\sGMT\+4|\sGST/, '') + ' GST';
        }

        // Get event details from poll response
        const event = poll.event || {};
        const eventTitle = event.title || 'Event';
        const eventDescription = event.description || '';
        const eventLocation = event.location || '';
        
        const eventDateObj = event.event_date ? new Date(event.event_date) : null;
        const eventDate = eventDateObj ? formatEventDateWithGST(eventDateObj) : '';

        document.getElementById('poll-title').textContent = `Time Poll: ${eventTitle}`;
        document.getElementById('poll-subtitle').textContent = 'Select your preferred time slot';
        
        // Display event details
        const eventDetailsContainer = document.getElementById('event-details-container');
        eventDetailsContainer.innerHTML = `
          <h2 class="text-xl font-semibold mb-4 text-gray-900">${eventTitle}</h2>
          ${eventDescription ? `<div class="prose max-w-none text-gray-700 mb-4">${eventDescription.replace(/\n/g, '<br>')}</div>` : ''}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${eventDate ? `<div><strong class="text-gray-900">Event Date:</strong> <div style="color: #f97316; font-weight: bold;">${eventDate}</div></div>` : ''}
            ${eventLocation ? `<div><strong class="text-gray-900">Location:</strong> <span style="color: #f97316; font-weight: bold;">${eventLocation}</span></div>` : ''}
          </div>
        `;

        // Check if poll deadline has passed
        const deadline = poll.deadline ? new Date(poll.deadline) : null;
        const now = new Date();
        const isDeadlinePassed = deadline && now > deadline;
        
        // Display deadline notice
        const deadlineNotice = document.getElementById('deadline-notice');
        if (deadline) {
          const deadlineStr = formatDateWithGST(deadline);
          
          if (isDeadlinePassed) {
            deadlineNotice.innerHTML = `
              <div class="p-4 bg-red-50 border border-red-200 rounded-md">
                <p class="text-sm text-red-800">
                  <strong>Voting Closed:</strong> The poll deadline has passed
                </p>
                <div class="text-sm text-red-700 mt-1" style="color: #f97316; font-weight: bold;">${deadlineStr}</div>
              </div>
            `;
            // Disable voting form
            document.getElementById('voting-form-container').classList.add('hidden');
          } else {
            deadlineNotice.innerHTML = `
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-md">
                <p class="text-sm text-blue-800">
                  <strong>Voting Deadline:</strong>
                </p>
                <div class="text-sm text-blue-700 mt-1" style="color: #f97316; font-weight: bold;">${deadlineStr}</div>
              </div>
            `;
          }
        }

        // Display time slots with vote counts
        const timeSlotsContainer = document.getElementById('time-slots');
        const voteOptionsContainer = document.getElementById('time-slot-options');
        
        poll.time_slots.forEach((slot, index) => {
          const date = new Date(slot);
          const formattedDate = formatDateWithGST(date);
          
          const voteCount = poll.voteCounts?.[index] || 0;
          
          // Display slot with vote count
          const slotDiv = document.createElement('div');
          slotDiv.className = 'p-4 border border-gray-200 rounded-lg';
          slotDiv.innerHTML = `
            <div class="flex justify-between items-center">
              <div>
                <div class="font-semibold text-gray-900">Option ${index + 1}</div>
                <div style="color: #f97316; font-weight: bold;">${formattedDate}</div>
              </div>
              <div class="text-sm text-gray-600">
                ${voteCount} ${voteCount === 1 ? 'vote' : 'votes'}
              </div>
            </div>
          `;
          timeSlotsContainer.appendChild(slotDiv);

          // Radio button option
          const radioDiv = document.createElement('div');
          radioDiv.className = 'flex items-center p-3 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer';
          radioDiv.innerHTML = `
            <input
              type="radio"
              id="slot-${index}"
              name="time_slot"
              value="${index}"
              required
              class="mr-3"
            />
            <label for="slot-${index}" class="flex-1 cursor-pointer">
              <div style="color: #f97316; font-weight: bold;">${formattedDate}</div>
              <div class="text-xs text-gray-500 mt-1">${voteCount} ${voteCount === 1 ? 'vote' : 'votes'}</div>
            </label>
          `;
          voteOptionsContainer.appendChild(radioDiv);
        });

        // Check if already voted
        const urlParams = new URLSearchParams(window.location.search);
        const voted = urlParams.get('voted') === 'true';
        if (voted) {
          document.getElementById('success-message').classList.remove('hidden');
          document.getElementById('voting-form-container').classList.add('hidden');
        }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('poll-content').classList.remove('hidden');
      } catch (err) {
        console.error('Error loading poll:', err);
        document.getElementById('loading').classList.add('hidden');
        const errorState = document.getElementById('error-state');
        errorState.classList.remove('hidden');
        errorState.style.display = 'flex';
      }
    }

    // Handle form submission
    document.getElementById('voting-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const successMessage = document.getElementById('success-message');
      const errorMessage = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      
      // Hide previous messages
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      if (!pollData || !pollData.id) {
        errorText.textContent = 'Poll data not loaded. Please refresh the page.';
        errorMessage.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Cast Your Vote';
        return;
      }
      
      const selectedSlot = document.querySelector('input[name="time_slot"]:checked');
      if (!selectedSlot) {
        errorText.textContent = 'Please select a time slot.';
        errorMessage.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Cast Your Vote';
        return;
      }
      
      const formData = {
        poll_id: pollData.id,
        selected_slot_index: parseInt(selectedSlot.value),
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        company: document.getElementById('company').value.trim()
      };

      try {
        const response = await fetch('/.netlify/functions/pollVotes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to submit vote');
        }

        // Show success and reload to show updated vote counts
        successMessage.classList.remove('hidden');
        document.getElementById('voting-form-container').classList.add('hidden');
        
        // Update URL to show voted state
        window.history.replaceState({}, '', `${window.location.pathname}?voted=true`);
        
        // Reload to show updated vote counts
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } catch (err) {
        errorText.textContent = err.message;
        errorMessage.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Vote';
      }
    });

    // Initialize
    loadIdaicLogo();
    loadPoll();
  </script>
</body>
</html>

