<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event - IDAIC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body { 
      font-family: 'Inter', sans-serif;
      overflow-x: hidden; /* Prevent horizontal scrolling */
    }
    .event-header {
      background-image: url('https://xnjpbkcqfuvegiwdxypw.supabase.co/storage/v1/object/public/logos/download_events.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      min-height: 300px; /* Minimum height for mobile */
      width: 100%;
      max-width: 100vw; /* Prevent overflow */
    }
    @media (min-width: 640px) {
      .event-header {
        min-height: 400px;
      }
    }
    @media (min-width: 1024px) {
      .event-header {
        min-height: 500px;
      }
    }
    .event-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
    }
    .event-header-content {
      position: relative;
      z-index: 1;
    }
    /* Ensure images are responsive */
    img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="min-h-screen">
    <!-- Loading State -->
    <div id="loading" class="flex items-center justify-center min-h-screen">
      <div class="text-gray-500">Loading event...</div>
    </div>

    <!-- Event Page -->
    <div id="event-content" class="hidden">
      <!-- Header Banner -->
      <div class="event-header text-white">
        <div class="event-header-content max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-20 sm:pt-28 lg:pt-36 pb-0 flex items-end justify-center min-h-full">
          <div class="w-full text-center mb-8 sm:mb-12 lg:mb-16">
            <div class="flex flex-col items-center">
              <div class="w-full">
                <h1 id="event-title" class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-2 break-words" style="color: #f97316;"></h1>
                <div id="event-meta" class="text-gray-100 text-xs sm:text-sm lg:text-base"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <!-- Success Message -->
        <div id="success-message" class="hidden mb-4 sm:mb-6 p-3 sm:p-4 bg-green-50 border border-green-200 rounded-md">
          <div class="flex items-start sm:items-center">
            <svg class="h-5 w-5 text-green-500 mr-2 flex-shrink-0 mt-0.5 sm:mt-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-xs sm:text-sm text-green-800 break-words">You have successfully registered for this event!</p>
          </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden mb-4 sm:mb-6 p-3 sm:p-4 bg-red-50 border border-red-200 rounded-md">
          <p class="text-xs sm:text-sm text-red-800 break-words" id="error-text"></p>
        </div>

        <!-- Event Details -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 lg:p-8 mb-6">
          <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-900">Event Details</h2>
          <div id="event-description" class="prose max-w-none text-gray-700 mb-6"></div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
            <div>
              <h3 class="text-xs sm:text-sm font-bold text-gray-900 mb-1 sm:mb-2">Date & Time</h3>
              <p id="event-date" class="text-sm sm:text-base text-gray-900 break-words"></p>
            </div>
            <div>
              <h3 class="text-xs sm:text-sm font-bold text-gray-900 mb-1 sm:mb-2">Location</h3>
              <p id="event-location" class="text-sm sm:text-base text-gray-900 break-words"></p>
            </div>
          </div>

          <div id="agenda-container" class="mb-6"></div>
          <div id="registration-link-container" class="mb-6"></div>
        </div>

        <!-- Registration Form -->
        <div id="registration-form-container" class="bg-white rounded-lg shadow-lg p-4 sm:p-6 lg:p-8">
          <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-900">Register for this Event</h2>
          
          <form id="registration-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Name *
              </label>
              <input
                type="text"
                id="name"
                name="name"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Email *
              </label>
              <input
                type="email"
                id="email"
                name="email"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Company
              </label>
              <input
                type="text"
                id="company"
                name="company"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-900">
                Title/Position
              </label>
              <input
                type="text"
                id="title"
                name="title"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              />
            </div>

            <button
              type="submit"
              id="submit-btn"
              class="w-full px-4 sm:px-6 py-2.5 sm:py-3 bg-orange-500 text-white rounded-md text-sm sm:text-base font-medium hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Register for Event
            </button>
          </form>
        </div>
      </div>

      <!-- Footer -->
      <footer class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 mt-6 sm:mt-8 border-t border-gray-200">
        <div class="flex flex-col items-center justify-center mb-4 sm:mb-6">
          <a href="https://www.idaic.org" target="_blank" rel="noopener noreferrer" class="mb-3 sm:mb-4">
            <img id="idaic-logo" alt="IDAIC Logo" class="h-10 sm:h-12 w-auto object-contain max-w-full" style="display: none;" />
          </a>
        </div>
        <p class="text-xs sm:text-sm text-gray-600 text-center leading-relaxed px-2">
          This event is created and managed by IDAIC, under the direction of the meeting organizer. The data processing that occurs for purposes of this event is subject to the terms of the meeting organiser.
        </p>
      </footer>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden items-center justify-center min-h-screen" style="display: none;">
      <div class="text-center">
        <p class="text-red-600 mb-4">Event not found</p>
        <a href="https://www.idaic.org" class="text-orange-500 hover:underline">Return to IDAIC</a>
      </div>
    </div>
  </div>

  <script>
    // Get event ID from URL
    // Support both /events-UUID and /events-UUID/ formats
    let eventId = '';
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const eventPath = pathParts[pathParts.length - 1];
    if (eventPath && eventPath.startsWith('events-')) {
      eventId = eventPath.replace('events-', '');
    } else if (pathParts.length >= 2 && pathParts[pathParts.length - 2] === 'events') {
      eventId = pathParts[pathParts.length - 1];
    }
    
    // Fallback: try to get from query parameter
    if (!eventId) {
      const urlParams = new URLSearchParams(window.location.search);
      eventId = urlParams.get('id') || urlParams.get('event_id');
    }

    // Fetch IDAIC logo
    async function loadIdaicLogo() {
      try {
        const response = await fetch('/.netlify/functions/orgs');
        if (response.ok) {
          const orgs = await response.json();
          const idaic = orgs.find(org => 
            org.name && (
              org.name.toLowerCase().includes('idaic') ||
              org.name.toLowerCase() === 'idaic'
            ) && org.logo_url
          );
          if (idaic && idaic.logo_url) {
            const logoImg = document.getElementById('idaic-logo');
            logoImg.src = idaic.logo_url;
            logoImg.style.display = 'block';
          }
        }
      } catch (err) {
        console.error('Error fetching IDAIC logo:', err);
      }
    }

    // Load event data
    async function loadEvent() {
      try {
        const response = await fetch('/.netlify/functions/events');
        if (!response.ok) throw new Error('Failed to fetch events');
        
        const events = await response.json();
        const event = events.find(e => e.id === eventId);
        
        if (!event) {
          document.getElementById('loading').classList.add('hidden');
          const errorState = document.getElementById('error-state');
          errorState.classList.remove('hidden');
          errorState.style.display = 'flex';
          return;
        }

        // Populate event data
        document.getElementById('event-title').textContent = event.title || 'Event';
        
        // Helper function to format date with GST timezone
        function formatDateWithGST(date) {
          const options = {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Asia/Dubai'
          };
          const formatted = date.toLocaleDateString('en-GB', options);
          // Replace timezone abbreviation with GST
          return formatted.replace(/\sGMT\+4|\sGST/, '') + ' GST';
        }
        
        const eventDate = event.event_date ? new Date(event.event_date) : null;
        let dateStr = 'TBA';
        
        if (eventDate) {
          dateStr = formatDateWithGST(eventDate);
        }
        
        // Display date in normal text (not bold, not orange) in event details
        document.getElementById('event-date').textContent = dateStr;
        document.getElementById('event-location').textContent = event.location || 'TBA';
        
        // Show date and time in header meta in orange
        const metaHtml = [];
        if (eventDate) {
          metaHtml.push(`<span style="color: #f97316;">${dateStr}</span>`);
        }
        if (event.location) {
          metaHtml.push(`<span>${event.location}</span>`);
        }
        document.getElementById('event-meta').innerHTML = metaHtml.length > 0 ? metaHtml.join(' â€¢ ') : '';
        
        if (event.description) {
          // Ensure description uses default gray color, not orange
          const descElement = document.getElementById('event-description');
          descElement.innerHTML = event.description.replace(/\n/g, '<br>');
          descElement.className = 'prose max-w-none text-sm sm:text-base text-gray-700 mb-4 sm:mb-6 break-words';
        } else {
          document.getElementById('event-description').textContent = 'No description available.';
        }

        // Display agenda if available
        if (event.agenda) {
          const agendaContainer = document.getElementById('agenda-container');
          agendaContainer.innerHTML = `
            <div>
              <h3 class="text-xs sm:text-sm font-bold text-gray-900 mb-2">Agenda</h3>
              <div class="prose max-w-none text-xs sm:text-sm text-gray-700 whitespace-pre-line break-words" style="color: #374151;">${event.agenda.replace(/\n/g, '<br>')}</div>
            </div>
          `;
        }

        // Display online event link if available
        if (event.registration_link) {
          const linkContainer = document.getElementById('registration-link-container');
          linkContainer.innerHTML = `
            <div>
              <h3 class="text-xs sm:text-sm font-semibold text-gray-500 mb-2">Join Online Event</h3>
              <a
                href="${event.registration_link}"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-xs sm:text-sm transition-colors"
              >
                Join Online Event
                <svg class="ml-2 h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
              </a>
            </div>
          `;
        }

        // Check if already registered
        const urlParams = new URLSearchParams(window.location.search);
        const registered = urlParams.get('registered') === 'true';
        if (registered) {
          document.getElementById('success-message').classList.remove('hidden');
          document.getElementById('registration-form-container').classList.add('hidden');
        }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('event-content').classList.remove('hidden');
      } catch (err) {
        console.error('Error loading event:', err);
        document.getElementById('loading').classList.add('hidden');
        const errorState = document.getElementById('error-state');
        errorState.classList.remove('hidden');
        errorState.style.display = 'flex';
      }
    }

    // Handle form submission
    document.getElementById('registration-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const successMessage = document.getElementById('success-message');
      const errorMessage = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      
      // Hide previous messages
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Registering...';
      
      const formData = {
        event_id: eventId,
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        company: document.getElementById('company').value.trim(),
        title: document.getElementById('title').value.trim()
      };

      try {
        const response = await fetch('/.netlify/functions/eventRegistrations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to register');
        }

        // Show success and redirect
        successMessage.classList.remove('hidden');
        document.getElementById('registration-form-container').classList.add('hidden');
        
        // Update URL to show registered state
        window.history.replaceState({}, '', `${window.location.pathname}?registered=true`);
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (err) {
        errorText.textContent = err.message;
        errorMessage.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Register for Event';
      }
    });

    // Auto-fill form fields from URL parameters or parent window (for members portal)
    function autoFillForm() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // Get data from URL parameters
      const name = urlParams.get('name');
      const email = urlParams.get('email');
      const company = urlParams.get('company');
      
      // Try to get data from parent window if in iframe (members portal)
      let parentData = null;
      let messageListener = null;
      try {
        if (window.parent && window.parent !== window) {
          // Request user data from parent (members portal)
          window.parent.postMessage({ type: 'requestUserData' }, '*');
          
          // Listen for response with timeout and cleanup
          messageListener = function(event) {
            // Only process messages from expected origin
            if (event.data && event.data.type === 'userData') {
              const data = event.data.data || {};
              if (data.name && !document.getElementById('name').value) {
                document.getElementById('name').value = data.name;
              }
              if (data.email && !document.getElementById('email').value) {
                document.getElementById('email').value = data.email;
              }
              if (data.company && !document.getElementById('company').value) {
                document.getElementById('company').value = data.company;
              }
              // Remove listener after receiving data
              if (messageListener) {
                window.removeEventListener('message', messageListener);
                messageListener = null;
              }
            }
          };
          
          window.addEventListener('message', messageListener);
          
          // Cleanup listener after 5 seconds to prevent memory leaks
          setTimeout(() => {
            if (messageListener) {
              window.removeEventListener('message', messageListener);
              messageListener = null;
            }
          }, 5000);
        }
      } catch (e) {
        // Cross-origin restrictions - ignore
        console.log('Cannot access parent window:', e);
        if (messageListener) {
          window.removeEventListener('message', messageListener);
        }
      }
      
      // Fill from URL parameters if available
      if (name && !document.getElementById('name').value) {
        document.getElementById('name').value = decodeURIComponent(name);
      }
      if (email && !document.getElementById('email').value) {
        document.getElementById('email').value = decodeURIComponent(email);
      }
      if (company && !document.getElementById('company').value) {
        document.getElementById('company').value = decodeURIComponent(company);
      }
    }

    // Initialize
    loadIdaicLogo();
    loadEvent().then(() => {
      // Auto-fill after event loads and form is visible
      setTimeout(() => {
        autoFillForm();
      }, 100);
    });
  </script>
</body>
</html>

